import axios from "axios";

import { FileTypeResult } from "file-type";

import { Anti_malware } from "@/backend/enums/anti_malware";

type Props = {
    file_buffer: Buffer,
    type: FileTypeResult,
    file: File
}

export default async function Malware(props: Props): Promise<Anti_malware> {
    const { file_buffer, type, file } = props;

    try {
        const form = new FormData();
        const blob = new Blob([file_buffer], { type: type.mime });
        form.append('file', blob, file.name);

        const response_upload = await axios.post('https://www.virustotal.com/api/v3/files', form, {
            headers: {
                accept: 'application/json',
                'x-apikey': process.env.VIRUSTOTAL_API_KEY,
            },
        })

        // Realiza una solicitud para obtener los resultados del anÃ¡lisis
        const response_analysis = await axios.get(`https://www.virustotal.com/api/v3/analyses/${response_upload.data.data.id}`, {
            headers: {
                accept: 'application/json',
                'x-apikey': process.env.VIRUSTOTAL_API_KEY,
            },
        });

        // Procesa la respuesta para ver si el archivo tiene virus
        const { stats } = response_analysis.data.data.attributes;

        return (stats && stats.malicious > 0) ? Anti_malware.VIRUS : Anti_malware.FREE;
    } catch (error) {
        return Anti_malware.ERROR;
    }
}